#!/usr/bin/env python
# -*- coding: utf-8 -*-

import streamlit as st
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns
import plotly.express as px
import plotly.graph_objects as go
import requests
from datetime import datetime
import json
import os
import time

# Configura√ß√µes da p√°gina
st.set_page_config(
    page_title="Dashboard - Previs√£o de Pre√ßos de Im√≥veis",
    page_icon="üè†",
    layout="wide",
    initial_sidebar_state="expanded"
)

# Constantes
API_URL = "http://localhost:8000"
ENDPOINTS = {
    "status": f"{API_URL}/status",
    "previsoes": f"{API_URL}/previsoes",
    "previsao": f"{API_URL}/prever"
}

# Fun√ß√£o para carregar dados da API
@st.cache_data(ttl=5)  # Cache com validade de 5 segundos
def carregar_status():
    try:
        response = requests.get(ENDPOINTS["status"])
        return response.json()
    except Exception as e:
        st.error(f"Erro ao carregar status da API: {e}")
        return None

@st.cache_data(ttl=5)  # Cache com validade de 5 segundos
def carregar_previsoes():
    try:
        response = requests.get(ENDPOINTS["previsoes"])
        return response.json()
    except Exception as e:
        st.error(f"Erro ao carregar previs√µes: {e}")
        return []

def realizar_previsao(dados):
    try:
        response = requests.post(ENDPOINTS["previsao"], json=dados)
        return response.json()
    except Exception as e:
        st.error(f"Erro ao realizar previs√£o: {e}")
        return None

# Fun√ß√£o para formatar timestamp
def formatar_data(timestamp_str):
    try:
        dt = datetime.fromisoformat(timestamp_str.replace('Z', '+00:00'))
        return dt.strftime('%d/%m/%Y %H:%M:%S')
    except:
        return timestamp_str

# Sidebar: Informa√ß√µes da API
st.sidebar.title("API de Previs√µes")
status_api = carregar_status()

if status_api:
    st.sidebar.metric("Status do Modelo", 
                     "Treinado ‚úÖ" if status_api.get("modelo_carregado") else "N√£o treinado ‚ùå")
    
    estatisticas = status_api.get("estatisticas_api", {})
    
    # Uptime
    uptime_segundos = estatisticas.get("uptime_seconds", 0)
    dias = uptime_segundos // (24 * 3600)
    horas = (uptime_segundos % (24 * 3600)) // 3600
    minutos = (uptime_segundos % 3600) // 60
    
    st.sidebar.metric("Uptime", f"{int(dias)}d {int(horas)}h {int(minutos)}m")
    
    # M√©tricas de requisi√ß√µes
    col1, col2 = st.sidebar.columns(2)
    col1.metric("Total de Requisi√ß√µes", estatisticas.get("total_requests", 0))
    col2.metric("Requisi√ß√µes com Sucesso", estatisticas.get("successful_requests", 0))
    
    col1, col2 = st.sidebar.columns(2)
    col1.metric("Previs√µes Realizadas", estatisticas.get("previsoes_realizadas", 0))
    col2.metric("Treinamentos", estatisticas.get("treinamentos_realizados", 0))
    
    # √öltimo erro
    ultimo_erro = estatisticas.get("ultimo_erro")
    if ultimo_erro:
        st.sidebar.error("√öltimo Erro:")
        st.sidebar.text(f"Timestamp: {formatar_data(ultimo_erro.get('timestamp', ''))}")
        st.sidebar.text(f"Erro: {ultimo_erro.get('error', 'Desconhecido')}")
else:
    st.sidebar.error("API n√£o est√° dispon√≠vel. Verifique se a API est√° em execu√ß√£o.")

# Sidebar: Ferramenta de previs√£o
st.sidebar.title("Fazer Nova Previs√£o")

with st.sidebar.form("previsao_form"):
    area = st.number_input("√Årea (m¬≤)", min_value=10.0, max_value=10000.0, value=100.0, step=10.0)
    quartos = st.number_input("Quartos", min_value=0, max_value=10, value=2, step=1)
    banheiros = st.number_input("Banheiros", min_value=0, max_value=10, value=1, step=1)
    idade = st.number_input("Idade do Im√≥vel (anos)", min_value=0, max_value=100, value=5, step=1)
    
    submit_button = st.form_submit_button("Prever Pre√ßo")
    
    if submit_button:
        dados_previsao = {
            "area": area,
            "quartos": quartos,
            "banheiros": banheiros,
            "idade_imovel": idade
        }
        
        with st.spinner("Realizando previs√£o..."):
            resultado = realizar_previsao(dados_previsao)
            
        if resultado:
            preco = resultado.get("preco_previsto", 0)
            faixa = resultado.get("faixa_confianca", [0, 0])
            
            st.success(f"Pre√ßo Previsto: R$ {preco:,.2f}")
            st.info(f"Faixa de Confian√ßa: R$ {faixa[0]:,.2f} a R$ {faixa[1]:,.2f}")
            st.success("Previs√£o realizada com sucesso! Atualize o dashboard para ver nos gr√°ficos.")

# Conte√∫do principal
st.title("Dashboard - Previs√£o de Pre√ßos de Im√≥veis")

# Carrega o hist√≥rico de previs√µes
previsoes = carregar_previsoes()

if not previsoes:
    st.warning("N√£o h√° previs√µes para exibir. Fa√ßa algumas previs√µes para visualizar os gr√°ficos.")
else:
    # Converte para DataFrame
    df_previsoes = pd.DataFrame([
        {
            "id": p.get("request_id"),
            "timestamp": p.get("timestamp"),
            "area": p.get("input", {}).get("area"),
            "quartos": p.get("input", {}).get("quartos"),
            "banheiros": p.get("input", {}).get("banheiros"),
            "idade_imovel": p.get("input", {}).get("idade_imovel"),
            "preco_previsto": p.get("preco_previsto"),
            "faixa_inferior": p.get("faixa_confianca", [0, 0])[0],
            "faixa_superior": p.get("faixa_confianca", [0, 0])[1],
            "data_formatada": formatar_data(p.get("timestamp", ""))
        }
        for p in previsoes
    ])
    
    # Converte para datetime
    df_previsoes["timestamp"] = pd.to_datetime(df_previsoes["timestamp"])
    
    # M√©tricas Principais
    st.subheader("M√©tricas Gerais")
    col1, col2, col3, col4 = st.columns(4)
    col1.metric("Total de Previs√µes", len(df_previsoes))
    col2.metric("Pre√ßo M√©dio", f"R$ {df_previsoes['preco_previsto'].mean():,.2f}")
    col3.metric("Maior Pre√ßo", f"R$ {df_previsoes['preco_previsto'].max():,.2f}")
    col4.metric("Menor Pre√ßo", f"R$ {df_previsoes['preco_previsto'].min():,.2f}")
    
    # Gr√°ficos
    st.subheader("Visualiza√ß√µes")
    
    tab1, tab2, tab3, tab4 = st.tabs(["Distribui√ß√£o de Pre√ßos", "Correla√ß√µes", "Hist√≥rico de Previs√µes", "Dados Detalhados"])
    
    with tab1:
        st.subheader("Distribui√ß√£o dos Pre√ßos Previstos")
        
        # Histograma de pre√ßos
        fig = px.histogram(
            df_previsoes, 
            x="preco_previsto",
            nbins=30,
            title="Distribui√ß√£o dos Pre√ßos Previstos",
            labels={"preco_previsto": "Pre√ßo Previsto (R$)", "count": "Frequ√™ncia"},
            color_discrete_sequence=["#3366CC"]
        )
        st.plotly_chart(fig, use_container_width=True)
        
        # Boxplot por n√∫mero de quartos
        if df_previsoes["quartos"].notna().sum() > 0:
            fig = px.box(
                df_previsoes,
                x="quartos",
                y="preco_previsto",
                title="Pre√ßos por N√∫mero de Quartos",
                labels={"quartos": "Quartos", "preco_previsto": "Pre√ßo Previsto (R$)"}
            )
            st.plotly_chart(fig, use_container_width=True)
    
    with tab2:
        st.subheader("Correla√ß√µes entre Caracter√≠sticas e Pre√ßos")
        
        # Scatter plot: √Årea x Pre√ßo
        fig = px.scatter(
            df_previsoes,
            x="area",
            y="preco_previsto",
            size="quartos" if "quartos" in df_previsoes.columns else None,
            color="banheiros" if "banheiros" in df_previsoes.columns else None,
            title="Rela√ß√£o entre √Årea e Pre√ßo Previsto",
            labels={
                "area": "√Årea (m¬≤)",
                "preco_previsto": "Pre√ßo Previsto (R$)",
                "quartos": "Quartos",
                "banheiros": "Banheiros"
            },
            trendline="ols"
        )
        st.plotly_chart(fig, use_container_width=True)
        
        # Heatmap de correla√ß√£o
        numeric_cols = df_previsoes.select_dtypes(include=[np.number]).columns
        corr_matrix = df_previsoes[numeric_cols].corr()
        
        fig = px.imshow(
            corr_matrix,
            text_auto=True,
            color_continuous_scale="RdBu_r",
            title="Matriz de Correla√ß√£o"
        )
        st.plotly_chart(fig, use_container_width=True)
    
    with tab3:
        st.subheader("Hist√≥rico de Previs√µes ao Longo do Tempo")
        
        # Previs√µes ao longo do tempo
        fig = px.line(
            df_previsoes.sort_values("timestamp"),
            x="timestamp",
            y="preco_previsto",
            title="Pre√ßos Previstos ao Longo do Tempo",
            labels={"timestamp": "Data/Hora", "preco_previsto": "Pre√ßo Previsto (R$)"}
        )
        st.plotly_chart(fig, use_container_width=True)
        
        # M√©dia m√≥vel de pre√ßos
        df_previsoes_ordenado = df_previsoes.sort_values("timestamp")
        df_previsoes_ordenado["media_movel"] = df_previsoes_ordenado["preco_previsto"].rolling(window=5).mean()
        
        fig = px.line(
            df_previsoes_ordenado,
            x="timestamp",
            y=["preco_previsto", "media_movel"],
            title="Pre√ßos Previstos com M√©dia M√≥vel (5 previs√µes)",
            labels={
                "timestamp": "Data/Hora", 
                "value": "Pre√ßo (R$)",
                "variable": "Tipo"
            }
        )
        fig.update_layout(legend_title_text="")
        st.plotly_chart(fig, use_container_width=True)
    
    with tab4:
        st.subheader("Dados Detalhados")
        
        # Filtros
        col1, col2 = st.columns(2)
        with col1:
            min_preco = st.slider("Pre√ßo M√≠nimo", 
                               float(df_previsoes["preco_previsto"].min()), 
                               float(df_previsoes["preco_previsto"].max()), 
                               float(df_previsoes["preco_previsto"].min()))
        with col2:
            max_preco = st.slider("Pre√ßo M√°ximo", 
                               float(df_previsoes["preco_previsto"].min()), 
                               float(df_previsoes["preco_previsto"].max()), 
                               float(df_previsoes["preco_previsto"].max()))
        
        # Filtra os dados
        df_filtrado = df_previsoes[
            (df_previsoes["preco_previsto"] >= min_preco) & 
            (df_previsoes["preco_previsto"] <= max_preco)
        ]
        
        # Tabela de dados
        st.dataframe(
            df_filtrado[["data_formatada", "area", "quartos", "banheiros", "idade_imovel", "preco_previsto"]].rename(
                columns={
                    "data_formatada": "Data/Hora",
                    "area": "√Årea (m¬≤)",
                    "quartos": "Quartos",
                    "banheiros": "Banheiros",
                    "idade_imovel": "Idade (anos)",
                    "preco_previsto": "Pre√ßo Previsto (R$)"
                }
            ),
            use_container_width=True
        )

# Footer
st.markdown("---")
st.caption("Dashboard de Previs√£o de Pre√ßos de Im√≥veis - App 6 - Desenvolvido com Streamlit")

# Atualiza√ß√£o autom√°tica
auto_refresh = st.sidebar.checkbox("Atualiza√ß√£o Autom√°tica (10s)", value=False)

if auto_refresh:
    st.empty()
    time.sleep(10)
    st.experimental_rerun() 